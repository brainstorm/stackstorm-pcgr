---
chain:
  - name: "up"
    ref: ansible.playbook
    parameters:
      playbook: "/opt/stackstorm/packs/pcgr/ansible/ansible/aws.yml"
      extra_vars:
           - "pcgr.execution_id={{ action_context.parent.execution_id }}"
    notify:
      on-success:
        routes:
          - umccr_slack
        message: "PCGR AWS instance up and running"
      on-failure:
        routes:
          - umccr_slack
        message: "Something went wrong instantiating PCGR on AWS"
    on-success: "submit_vcf"
  - name: "submit_vcf"
    ref: ansible.playbook
    parameters:
      playbook: "/opt/stackstorm/packs/pcgr/ansible/ansible/pcgr-run.yml" 
      extra_vars:
           - "pcgr.execution_id={{ action_context.parent.execution_id }}"
           - "pcgr.input_vcf={{ chain_input }}"
           - "pcgr.s3_vcf_bucket=umccr-pcgr"

    notify:
      on-success:
        routes:
          - umccr_slack
        message: "PCGR processing done"
      on-failure:
        routes:
          - umccr_slack
        message: "PCGR processing failed"
#  - name: "down"
#    ref: ansible.playbook
#    parameters:
#      playbook: "/opt/stackstorm/packs/pcgr/ansible/ansible/aws-teardown.yml"
#      extra_vars:
#           - "pcgr_id={{ action_context.parent.execution_id }}"
#    notify:
#      on-success:
#        routes:
#          - umccr_slack
#        message: "AWS instance up for PCGR"
#      on-failure:
#        routes:
#          - umccr_slack
#        message: "Something went wrong instantiating AWS"
#    on-success: "submit_vcf"

default: "up"
